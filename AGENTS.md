# AGENTS.md

このファイルは、本リポジトリで作業するエージェント（Codex）および人間コントリビュータが従う開発ルールを定義します。スコープはリポジトリ全体です。

## Golden Rule（必須）
- 実装・修正は「テストを先に書く（TDD）」こと。
- 既存不具合は、再現テストを先に追加し失敗を確認してから修正する。
- 仕様変更は、期待される振る舞いをテストで表現してから実装する。

## Test Cases（必須要件）
- 正常系・異常系の両方のテストケースを必ず追加する。
- Hspec の `it` の命名は次で統一する：
  - 正常系: `parses ...`
  - 異常系: `rejects ...`

## Workflow（Red → Green → Refactor）
- Red: `test/` に失敗する/未実装の最小テストを追加（命名は `parses`/`rejects`）。
- Green: `src/` の最小変更でテストを通す。
- Refactor: ふるまいを変えずに整理（常にグリーンを維持）。

## 例外（最小限）
- 緊急のビルド落ち/コンパイルエラーの解消のみ、先に実装してよい。
- ただし、直後に原因をカバーするテストを追加すること。

## テスト実行
- cabal: `cabal test`
- stack: `stack test`
- 絞り込み: `cabal test --test-options "-m \"<pattern>\""`
- 失敗（非0終了）を Red とみなす。

## テスト指針（Hspec）
- 置き場所: `test/<Area>Spec.hs`（例: `test/SemanticSpec.hs`）。
- `describe` は対象機能、`it` は “parses …/rejects …” で期待を簡潔に記述。
- パーサの回復系は「エラー登録＋AST形状」など外部契約を検証（Span 等への過度依存は避ける）。
- 必要に応じて Property ベースの追加も可（既存ポリシーを優先）。

## 実装指針
- AST / Parser / Semantic の整合を最優先。
- 型の破壊的変更は「設計上より良い形にする目的なら可」。その場合は理由の説明と、影響範囲をカバーするテスト更新を同時に行う。
- 新構文追加（例: FUNCTION / FUNCTION_BLOCK）は、
  1) 最小の成功/失敗テスト → 2) AST 拡張 → 3) Parser 実装 → 4) Semantic の順で進める。

## Done の定義
- 仕様差分/バグを説明するテストが存在する。
- 全テストがグリーン（`cabal test` / `stack test`）。
- 不要なデッドコードがない。

## コミット方針（推奨）
- 1: 失敗するテスト（Red）
- 2: 実装（Green）
- 3: リファクタ（必要に応じて）

## エージェント向け（Codex）
- 変更前に該当範囲のテストを追加/拡張して Red を確認する。
- 書き込みが必要な操作は、環境のポリシーに従いユーザー承認を得る。
- 仕様の曖昧さに直面したら、テスト案を提示して合意を取ってから実装する。

